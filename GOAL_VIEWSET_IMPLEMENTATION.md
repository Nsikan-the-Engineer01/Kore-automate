# Goal ViewSet Implementation

**File:** `core_apps/goals/views.py`  
**Status:** ✅ Complete  
**Date:** January 29, 2026

---

## Overview

Implemented a complete DRF ModelViewSet for the Goal API with:
- Standard CRUD operations (Create, Retrieve, Update)
- Custom status actions (pause, resume)
- User isolation with IsOwner permission
- Proper serializer routing
- Automatic user assignment on creation

---

## IsOwner Permission Class

**File:** `core_apps/goals/permissions.py`

```python
class IsOwner(permissions.BasePermission):
    """Object-level permission to only allow users to access their own goals."""
    
    def has_object_permission(self, request, view, obj):
        return obj.user == request.user
```

### Purpose
Enforces object-level ownership checks at the database level. Only allows users to:
- Retrieve their own goals
- Update their own goals
- Pause/resume their own goals
- Delete their own goals (if enabled)

### Usage
```python
permission_classes = [IsAuthenticated, IsOwner]
```

### Error Response
```json
{
  "detail": "You do not have permission to access this goal. It belongs to another user."
}
```

---

## GoalViewSet

**File:** `core_apps/goals/views.py`

### Class Definition

```python
class GoalViewSet(viewsets.ModelViewSet):
    permission_classes = [IsAuthenticated, IsOwner]
    lookup_field = 'id'
    ordering = ['-created_at']  # Newest first
```

### Configuration

| Setting | Value | Purpose |
|---------|-------|---------|
| `permission_classes` | IsAuthenticated, IsOwner | Require login + ownership |
| `lookup_field` | 'id' | Use UUID for lookups |
| `ordering` | '-created_at' | Sort by creation date (newest first) |

### Automatic Features

1. **User Filtering** — Only returns goals belonging to request.user
2. **Serializer Routing** — Automatically selects correct serializer per action
3. **Request Context** — Passes request to serializer (required for creation)

---

## API Routes

All routes are automatically generated by the DRF router.

### Standard CRUD Routes

#### 1. List Goals
**GET** `/api/v1/goals/`

**Permissions:** IsAuthenticated, IsOwner  
**Serializer:** GoalDetailSerializer  
**Parameters:** Ordering support (default: -created_at)

**Response:**
```json
{
  "count": 2,
  "next": null,
  "previous": null,
  "results": [
    {
      "id": "550e8400-...",
      "name": "Emergency Fund",
      "target_amount": "500000.00",
      "status": "ACTIVE",
      "total_contributed": "0.00",
      "progress_percent": 0,
      "created_at": "2026-01-29T10:30:00Z",
      "updated_at": "2026-01-29T10:30:00Z"
    },
    {
      "id": "660e8400-...",
      "name": "Vacation Fund",
      "target_amount": "200000.00",
      "status": "PAUSED",
      "total_contributed": "0.00",
      "progress_percent": 0,
      "created_at": "2026-01-28T09:00:00Z",
      "updated_at": "2026-01-28T09:00:00Z"
    }
  ]
}
```

#### 2. Create Goal
**POST** `/api/v1/goals/`

**Permissions:** IsAuthenticated, IsOwner  
**Serializer:** GoalCreateSerializer  
**Body:** name, target_amount, currency, metadata

**Request:**
```json
{
  "name": "Emergency Fund",
  "target_amount": "500000.00",
  "currency": "NGN",
  "metadata": {"priority": "high"}
}
```

**Response (201 Created):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Emergency Fund",
  "target_amount": "500000.00",
  "currency": "NGN",
  "status": "ACTIVE",
  "metadata": {"priority": "high"},
  "total_contributed": "0.00",
  "progress_percent": 0,
  "created_at": "2026-01-29T10:30:00Z",
  "updated_at": "2026-01-29T10:30:00Z"
}
```

#### 3. Retrieve Goal
**GET** `/api/v1/goals/{id}/`

**Permissions:** IsAuthenticated, IsOwner  
**Serializer:** GoalDetailSerializer  
**Parameters:** id (UUID)

**Response (200 OK):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Emergency Fund",
  "target_amount": "500000.00",
  "currency": "NGN",
  "status": "ACTIVE",
  "metadata": {"priority": "high"},
  "total_contributed": "0.00",
  "progress_percent": 0,
  "created_at": "2026-01-29T10:30:00Z",
  "updated_at": "2026-01-29T10:30:00Z"
}
```

#### 4. Update Goal
**PATCH** `/api/v1/goals/{id}/`

**Permissions:** IsAuthenticated, IsOwner  
**Serializer:** GoalUpdateSerializer  
**Body:** Any of (name, target_amount, currency, metadata)

**Request:**
```json
{
  "name": "Updated Name",
  "target_amount": "750000.00"
}
```

**Response (200 OK):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Updated Name",
  "target_amount": "750000.00",
  "currency": "NGN",
  "status": "ACTIVE",
  "metadata": {"priority": "high"},
  "total_contributed": "0.00",
  "progress_percent": 0,
  "created_at": "2026-01-29T10:30:00Z",
  "updated_at": "2026-01-29T10:35:00Z"
}
```

### Custom Action Routes

#### 5. Pause Goal
**POST** `/api/v1/goals/{id}/pause/`

**Permissions:** IsAuthenticated, IsOwner  
**Body:** Empty  
**Precondition:** Goal status must be ACTIVE

**Behavior:**
1. Checks that goal status is ACTIVE
2. Sets status to PAUSED
3. Saves to database
4. Returns updated goal

**Success Response (200 OK):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Emergency Fund",
  "target_amount": "500000.00",
  "currency": "NGN",
  "status": "PAUSED",
  "metadata": {"priority": "high"},
  "total_contributed": "0.00",
  "progress_percent": 0,
  "created_at": "2026-01-29T10:30:00Z",
  "updated_at": "2026-01-29T10:40:00Z"
}
```

**Error Response (400 Bad Request):**
```json
{
  "detail": "Can only pause ACTIVE goals. Current status: PAUSED"
}
```

**Error Cases:**
- Goal already PAUSED → 400 Bad Request
- Goal is COMPLETED → 400 Bad Request
- Goal is CANCELLED → 400 Bad Request
- Goal belongs to other user → 403 Forbidden
- Goal not found → 404 Not Found

#### 6. Resume Goal
**POST** `/api/v1/goals/{id}/resume/`

**Permissions:** IsAuthenticated, IsOwner  
**Body:** Empty  
**Precondition:** Goal status must be PAUSED

**Behavior:**
1. Checks that goal status is PAUSED
2. Sets status to ACTIVE
3. Saves to database
4. Returns updated goal

**Success Response (200 OK):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Emergency Fund",
  "target_amount": "500000.00",
  "currency": "NGN",
  "status": "ACTIVE",
  "metadata": {"priority": "high"},
  "total_contributed": "0.00",
  "progress_percent": 0,
  "created_at": "2026-01-29T10:30:00Z",
  "updated_at": "2026-01-29T10:45:00Z"
}
```

**Error Response (400 Bad Request):**
```json
{
  "detail": "Can only resume PAUSED goals. Current status: ACTIVE"
}
```

**Error Cases:**
- Goal is ACTIVE → 400 Bad Request
- Goal is COMPLETED → 400 Bad Request
- Goal is CANCELLED → 400 Bad Request
- Goal belongs to other user → 403 Forbidden
- Goal not found → 404 Not Found

---

## URL Configuration

**File:** `core_apps/goals/urls.py`

```python
from rest_framework.routers import DefaultRouter
from .views import GoalViewSet

router = DefaultRouter()
router.register('goals', GoalViewSet, basename='goals')

urlpatterns = [
    path('', include(router.urls)),
]
```

### Generated Routes

The DefaultRouter automatically generates:

```
POST   /api/v1/goals/                  → Create
GET    /api/v1/goals/                  → List
GET    /api/v1/goals/{id}/             → Retrieve
PATCH  /api/v1/goals/{id}/             → Update
POST   /api/v1/goals/{id}/pause/       → Pause (custom action)
POST   /api/v1/goals/{id}/resume/      → Resume (custom action)
DELETE /api/v1/goals/{id}/             → Destroy (optional)
```

### Integration in Main URLs

In your main `config/urls.py`:

```python
from django.urls import path, include

urlpatterns = [
    # ... other patterns
    path('api/v1/', include('core_apps.goals.urls')),
]
```

Or if you have an API router:

```python
from rest_framework.routers import DefaultRouter
from core_apps.goals.views import GoalViewSet

api_router = DefaultRouter()
api_router.register('goals', GoalViewSet, basename='goals')

urlpatterns = [
    path('api/v1/', include(api_router.urls)),
]
```

---

## Serializer Routing

The viewset automatically selects the correct serializer:

| Action | Serializer |
|--------|-----------|
| create, POST | GoalCreateSerializer |
| update, PATCH | GoalUpdateSerializer |
| partial_update, PATCH | GoalUpdateSerializer |
| retrieve, list | GoalDetailSerializer |
| pause, POST custom | GoalDetailSerializer |
| resume, POST custom | GoalDetailSerializer |

---

## Permissions Enforcement

### IsAuthenticated
- Required for all endpoints
- User must be logged in
- Checked before any view code executes

### IsOwner
- Checked for object-level operations (retrieve, update, pause, resume)
- List operations filter by user instead
- Prevents accessing other users' goals

### Permission Flow

```
GET /api/v1/goals/
  ↓
IsAuthenticated check
  ↓
Filter queryset to request.user
  ↓
Return user's goals only

GET /api/v1/goals/{other_user_goal_id}/
  ↓
IsAuthenticated check ✓
  ↓
IsOwner check (obj.user == request.user)
  ↓
403 Forbidden (object belongs to other user)
```

---

## Usage Examples

### List User's Goals

```bash
curl -X GET http://localhost:8000/api/v1/goals/ \
  -H "Authorization: Bearer <token>"
```

### Create a Goal

```bash
curl -X POST http://localhost:8000/api/v1/goals/ \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Emergency Fund",
    "target_amount": "500000.00",
    "currency": "NGN",
    "metadata": {"priority": "high"}
  }'
```

### Get Goal Details

```bash
curl -X GET http://localhost:8000/api/v1/goals/550e8400-.../ \
  -H "Authorization: Bearer <token>"
```

### Update Goal

```bash
curl -X PATCH http://localhost:8000/api/v1/goals/550e8400-.../ \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Updated Goal Name",
    "target_amount": "750000.00"
  }'
```

### Pause Goal

```bash
curl -X POST http://localhost:8000/api/v1/goals/550e8400-.../pause/ \
  -H "Authorization: Bearer <token>"
```

### Resume Goal

```bash
curl -X POST http://localhost:8000/api/v1/goals/550e8400-.../resume/ \
  -H "Authorization: Bearer <token>"
```

---

## Status Codes Reference

| Code | Meaning | When Used |
|------|---------|-----------|
| 200 | OK | Successful GET, PATCH, or action |
| 201 | Created | Successful POST create |
| 400 | Bad Request | Invalid data or state precondition |
| 403 | Forbidden | User doesn't own goal or not authenticated |
| 404 | Not Found | Goal not found |
| 500 | Server Error | Unexpected server error |

---

## Error Response Format

All errors follow this format:

**Validation Error (Create/Update):**
```json
{
  "field_name": ["Error message"]
}
```

**Permission Error:**
```json
{
  "detail": "You do not have permission to access this goal. It belongs to another user."
}
```

**State Error (Pause/Resume):**
```json
{
  "detail": "Can only pause ACTIVE goals. Current status: PAUSED"
}
```

**Not Found Error:**
```json
{
  "detail": "Not found."
}
```

---

## Advanced Features

### Filtering & Ordering

The viewset respects DRF's ordering parameter:

```bash
# Get newest goals first (default)
GET /api/v1/goals/?ordering=-created_at

# Get oldest goals first
GET /api/v1/goals/?ordering=created_at
```

### Pagination

With DRF pagination enabled, responses include:

```json
{
  "count": 10,
  "next": "http://localhost:8000/api/v1/goals/?page=2",
  "previous": null,
  "results": [...]
}
```

### Custom Serializer Context

The viewset automatically passes request context to serializers:

```python
context = {
    'request': request,
    'format': 'json',
    'view': self
}
```

---

## Future Enhancements

1. **Bulk Operations** — Create/update multiple goals
2. **Filtering** — Filter by status, amount range, date range
3. **Partial Delete** — Soft delete instead of hard delete
4. **Webhooks** — Notify when goals are paused/resumed
5. **Analytics** — Goal progress endpoints
6. **Sharing** — Share goal with other users

---

## Testing

Example test cases for the viewset:

```python
from django.test import TestCase
from rest_framework.test import APIClient
from django.contrib.auth.models import User
from core_apps.goals.models import Goal

class GoalViewSetTestCase(TestCase):
    def setUp(self):
        self.client = APIClient()
        self.user = User.objects.create_user(username='testuser')
        self.client.force_authenticate(user=self.user)
    
    def test_create_goal(self):
        data = {
            'name': 'Test Goal',
            'target_amount': '50000.00'
        }
        response = self.client.post('/api/v1/goals/', data)
        self.assertEqual(response.status_code, 201)
        self.assertEqual(response.data['status'], 'ACTIVE')
    
    def test_pause_goal(self):
        goal = Goal.objects.create(
            user=self.user,
            name='Test',
            target_amount=50000.00,
            status='ACTIVE'
        )
        response = self.client.post(f'/api/v1/goals/{goal.id}/pause/')
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data['status'], 'PAUSED')
    
    def test_resume_goal(self):
        goal = Goal.objects.create(
            user=self.user,
            name='Test',
            target_amount=50000.00,
            status='PAUSED'
        )
        response = self.client.post(f'/api/v1/goals/{goal.id}/resume/')
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data['status'], 'ACTIVE')
    
    def test_cannot_access_other_users_goal(self):
        other_user = User.objects.create_user(username='other')
        goal = Goal.objects.create(
            user=other_user,
            name='Other User Goal',
            target_amount=50000.00
        )
        response = self.client.get(f'/api/v1/goals/{goal.id}/')
        self.assertEqual(response.status_code, 403)
```

---

**Status:** ✅ Complete  
**Last Updated:** January 29, 2026
